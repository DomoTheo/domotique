<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Assistant Domotique</title>
</head>
<body>
  <h1>Assistant Vocal Domotique</h1>
  <p id="status">Écoute en cours...</p>

  <script>
    const synth = window.speechSynthesis;
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'fr-FR';
    recognition.continuous = true;
    recognition.interimResults = true;

    let maleVoice = null;

    // Charger les voix disponibles et choisir une voix masculine en français
    function loadVoices() {
      const voices = synth.getVoices();
      maleVoice = voices.find(voice =>
        voice.lang.startsWith('fr') &&
        (voice.name.toLowerCase().includes('homme') || voice.name.toLowerCase().includes('male'))
      );

      if (!maleVoice) {
        console.warn("Voix masculine FR non trouvée, utilisation par défaut.");
      } else {
        console.log("Voix masculine trouvée :", maleVoice.name);
      }
    }

    // Parler avec la voix masculine si dispo
    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      if (maleVoice) {
        utter.voice = maleVoice;
      }
      synth.speak(utter);
    }

    // Charger les voix après que le navigateur les a disponibles
    if (synth.onvoiceschanged !== undefined) {
      synth.onvoiceschanged = loadVoices;
    }

    function sendDomoticCommand(state) {
      const stateUpper = state.toUpperCase();
      const url = `http://domo.theo.free.fr/update_statuts.php?place=bureau&state=${stateUpper}`;
      fetch(url)
        .then(response => {
          if (response.ok) {
            speak(`C'est fait, la lumière est ${state === "on" ? "allumée" : "éteinte"}.`);
            document.getElementById("status").textContent = `Lumière ${state === "on" ? "allumée" : "éteinte"}`;
          } else {
            throw new Error("Erreur lors de l'envoi");
          }
        })
    }

    recognition.onresult = function(event) {
      const result = event.results[event.results.length - 1][0].transcript.toLowerCase();
      console.log("Tu as dit :", result);
      document.getElementById("status").textContent = `Tu as dit : ${result}`;

      if (result.includes("dis siri")) {
        speak("Je t'écoute");

        if (result.includes("allume") && result.includes("lumière")) {
          speak("J'allume la lumière.");
          sendDomoticCommand("on");
        } else if (result.includes("éteins") && result.includes("lumière")) {
          speak("J'éteins la lumière.");
          sendDomoticCommand("off");
        }
      }
    };

    recognition.start();
    recognition.onend = () => {
      recognition.start();
    };
  </script>
</body>
</html>
